<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Lidar Three.js</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			* {
				margin: 0;
				padding: 0;
				-webkit-user-select: none;
				-moz-user-select: none;
				user-select: none;
			}
            body {
				font-family: Monospace;
				font-size: 13px;
				line-height: 24px;
				overscroll-behavior: none;
				overflow: hidden;
				background-color: #D3D3D3
			}
			#info {
				position:absolute;
				text-align: center;
				width: 100%;
				height: 100%;
				top: 0;
			}
        </style>
	</head>
    <body>
		<div id="container"></div>
		<div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a>
			 webgl - LiDAR - Mesh Construction
		</div>
        <script type="importmap">
			{
				"imports": {
					"three": "/js/libraries/three.module.js",
					"three/addons/": "/js/libraries/"
				}
			}
		</script>
        <script type="module">
            import * as THREE from 'three'
			import { OrbitControls } from 'three/addons/OrbitControls.js'
			import { GUI } from 'three/addons/dat.gui.module.js'
			import { MTLLoader } from 'three/addons/MTLLoader.js'
			import { OBJLoader } from 'three/addons/OBJLoader.js'
			import { GLTFLoader } from 'three/addons/GLTFLoader.js'
			import { PLYLoader } from 'three/addons/PLYLoader.js'

			import parameters from '/assets/json/parameters.json' assert { type: 'json' }

			const NUMBER_OF_ASSETS = 1

			const mtl_loader = new MTLLoader().setPath( './assets/models/' )
			const obj_loader = new OBJLoader().setPath( './assets/models/' )
			const gltf_loader = new GLTFLoader().setPath( './assets/models/' )
			const ply_loader = new PLYLoader().setPath( './assets/models/' )
			
			const ply = ['/ply/treeMesh.ply']
			const allObjects = []

			const tree = {
				object: new THREE.Object3D
			}

			const debug = {
				alert: true
			}

			class lidarThree {
				/*************************************************************\
      				Private methods
    			\*************************************************************/
				_bindEvents() {
					if ( debug.alert ) { console.log("Binding Events...") }
					window.addEventListener( 'resize', this.resize )

					this.controls.addEventListener( 'change', this.updateControls )
				}

				_generateAmbient( name ) {
					const ambient = new THREE.AmbientLight( 0xffffff, 0.2 )
					ambient.name = name
					return ambient
				}

				_generateFromPLY( name, ply ) {
					const g = new THREE.Object3D
					console.log( ply )
					g.copy( ply )
					g.name = name

					return g
				}

				_generateFromGLTF( name, gltf ) {
					const g = new THREE.Object3D
					g.copy( gltf )
					g.name = name

					return g
				}
				
				_loadAssets() {
					if ( debug.alert ) { console.log("Loading Assets...") }
					if ( this.assetsTotal === 0 ) { this.loadingComplete() }

					// PLY Objects
					for ( let i = 0; i < this.assetsTotal; i++ ) {
						allObjects[i] = new THREE.Object3D

						ply_loader.load( ply[i], ( geometry ) => {
							this.scene.add( new THREE.Mesh(geometry) )
							allObjects[i].copy.mesh
							this.checkProgress()
						})
					}
				}

				_makeMenus() {
					if ( debug.alert ) { console.log("Making Menus...") }

					const gui = new GUI( { width: 300 } )
				}
				/*************************************************************\
      				Public methods
    			\*************************************************************/
				constructor() {
					this.element.appendChild( this.renderer.domElement )
					this.render = this.render.bind( this )
					this.resize = this.resize.bind( this )
					this.updateControls = this.updateControls.bind( this )

					this._loadAssets()
				}

				/** Main */
				loadingComplete() {
					if ( debug.alert ) { console.log("Loading Complete!") }


					// Light
					this.scene.add( this._generateAmbient('ambient') )

					// Objects
					/* tree.object.copy( this._generateFromPLY('tree1', allObjects[0]) )
					console.log (tree)
					this.scene.add( tree ) */

					// Controls

					this._makeMenus()
					if ( debug.alert ) { console.log("Menus Made!") }
					this._bindEvents()
					if ( debug.alert ) { console.log("Events Bound!") }
					this.render()
				}

				checkProgress() {
					this.assetCount += 1
					if ( debug.alert ) { console.log( "Checking Progress...") }
					if ( this.assetCount >= this.assetsTotal ) {
						this.loadingComplete()
					}
				}

				render() {
					requestAnimationFrame( this.render )
					//this._update( this.delta )
					this.renderer.render( this.scene, this.camera )
				}
				
				resize() {
					this.camera.aspect = window.innerWidth / window.innerHeight
					this.camera.updateProjectionMatrix()

					this.renderer.setSize( window.innerWidth, window.innerHeight )

					this.render()
				}

				updateControls() {
					console.log("updating!")
				}
				/*************************************************************\
      				Getter methods
    			\*************************************************************/

				get assetCount() {
					return this._assetCount || ( this._assetCount = 0 )
				}

				get assetsTotal() {
					return this._assetsTotal || ( this._assetsTotal = NUMBER_OF_ASSETS )
				}
				
				get camera() {
					if ( this._camera ) {
						return this._camera
					}
					const camera = new THREE.PerspectiveCamera( this.fov, window.innerWidth / window.innerHeight, 1, 20000 )
        			camera.position.set( 0, 0, -10 )
        			camera.lookAt( 0, 0, 0 )

        			return ( this._camera = camera )
				}

				get controls() {
					if ( this._controls ) {
						return this._controls
					}
					console.log( this.camera, this.renderer.domElement )
					const controls = new OrbitControls( this.camera, this.renderer.domElement )
					controls.maxPolarAngle = Math.PI * 0.495
					controls.minDistance = 4.0
					controls.maxDistance = 600.0
					controls.update()

					return ( this._controls = controls )  
				}

				get element() {
        			return this._element || ( this._element = document.getElementById( 'container' ) )
    			}

				get fov() {
        			return this._fov || ( this._fov = 55 )
    			}

				get pmremGenerator() {
					if ( this._pmremGenerator ) {
						return this._pmremGenerator
					}
					const pmremGenerator = new THREE.PMREMGenerator( this.renderer )
					return ( this._pmremGenerator = pmremGenerator )
				}

				get renderer() {
					if ( this._renderer ) {
						return this._renderer
					}
					const renderer = new THREE.WebGLRenderer( { alpha:false, antialias: true } )
					renderer.setPixelRatio( window.devicePixelRatio )
					renderer.setSize( window.innerWidth, window.innerHeight )
					renderer.toneMapping = THREE.ACESFilmicToneMapping

					return ( this._renderer = renderer )
				}

				get scene() {
					if ( this._scene ) {
						return this._scene
					}
					const scene = new THREE.Scene()
					scene.background = new THREE.Color( 0x888888 )

					return ( this._scene = scene )
				}

				/*************************************************************\
				 Setters methods
				\*************************************************************/

				set assetCount( count ) {
					this._assetCount = count
				}

			}

			new lidarThree
        </script>
    </body>
</html>